<div class="container">
  <div class="back-link mt-5">
    <a routerLink="/products" class="text-decoration-none text-muted">
      <i class="bi bi-arrow-left"></i> Back to Products
    </a>
  </div>

  <div class="product-section row">
    <div class="product-image-col col-md-6 col-lg-6">
      <div class="image-gallery">
        <div class="main-image-wrapper">
          <ng-container *ngIf="product?.productMedias?.length">
            <ng-container [ngSwitch]="product.productMedias[currentImageIndex].mediaType">
              <div *ngSwitchCase="'Image'" class="image-zoom-container position-relative"
                (mousemove)="onImageMouseMove($event)" (mouseenter)="showZoom = true" (mouseleave)="showZoom = false">
                <img [src]="getCurrentImage()" [alt]="product.name + ' - Image ' + (currentImageIndex + 1)"
                  class="main-image" #mainImage>

                <div class="zoom-lens" [style.left.px]="lensPosition.x" [style.top.px]="lensPosition.y"
                  [class.d-none]="!showZoom"></div>
              </div>

              <div *ngSwitchCase="'Video'" class="video-container" (click)="toggleVideo(videoRef)">
                <video [src]="getCurrentImage()" class="main-video" #videoRef
                  (loadedmetadata)="onMetadataLoaded(videoRef)" (timeupdate)="onTimeUpdate(videoRef)"
                  (play)="onVideoPlay()" (pause)="onVideoPause()"></video>

                <div class="play-overlay" *ngIf="isShowingIcon">
                  <i class="bi"
                    [ngClass]=" videoStates[getCurrentImageNumber()-1].isPlaying ? 'bi-pause-fill' : 'bi-play-fill'"></i>
                </div>


                <div class="video-controls" [class.show]="showControls || !isPLayingVideo">
                  <div class="video-controls-row">
                    <button class="play-pause-btn" (click)="toggleVideo(videoRef); $event.stopPropagation()">
                      <i class="bi"
                        [ngClass]="videoStates[getCurrentImageNumber()-1].isPlaying ? 'bi-pause-fill' : 'bi-play-fill'"></i>
                    </button>
                    <div class="progress-container" (click)="seekVideo($event, videoRef)"
                      (mousedown)="onScrubbingStart($event,videoRef)" (mousemove)="onScrubbing($event, videoRef)"
                      (mouseup)="onScrubbingEnd()">
                      <div class="progress-bar" [style.width.%]="progressPercent">
                        <div class="progress-knob"></div>
                      </div>
                    </div>
                    <div class="video-timer">
                      {{ formatTime(currentTime) }} / {{ formatTime(duration) }}
                    </div>
                  </div>
                </div>
              </div>

            </ng-container>
          </ng-container>

          <div class="image-counter">
            {{ getCurrentImageNumber() }}/{{ getTotalImages() }}
          </div>

          <button class="nav-arrow prev" (click)="previousImage()" [disabled]="getTotalImages() <= 1">
            <i class="bi bi-chevron-left"></i>
          </button>
          <button class="nav-arrow next" (click)="nextImage()" [disabled]="getTotalImages() <= 1">
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>

        <div class="thumbnail-gallery" *ngIf="getTotalImages() > 1">
          <ng-container *ngFor="let media of product.productMedias; let i = index">
            <div [ngSwitch]="media.mediaType" class="thumbnail-wrapper" [class.active]="isActiveImage(i)"
              (click)="selectImage(i)">
              <img *ngSwitchCase="'Image'" [src]="getProductImageUrl(media.mediaUrl)"
                [alt]=" product.name + ' - Image ' + (i + 1)" class="thumbnail-image">
              <div *ngSwitchCase="'Video'" class="video-container">
                <video [src]="getProductImageUrl(media.mediaUrl)" class="thumbnail-video"></video>
                <div class="play-overlay-thumbnail" *ngIf="videoStates[i]?.showIcon">
                  <i class="bi" [ngClass]=" videoStates[i].isPlaying ? 'bi-pause-fill' : 'bi-play-fill'"></i>
                </div>
              </div>
            </div>
          </ng-container>
        </div>

      </div>
    </div>

    <div class="product-info-col col-md-6 col-lg-6 ps-5">
      <div class="category-stock-row">
        <span class="badge badge-category">{{ category?.name }}</span>
        <span *ngIf="product.stockQuantity > 0" class="badge badge-in-stock">In Stock</span>
        <span *ngIf="product.stockQuantity === 0" class="badge badge-out-of-stock">Out of Stock</span>
      </div>

      <h1 class="product-name">{{ product.name }}</h1>

      <h2 class="product-price">{{ product.price | indianCurrency }}</h2>

      <div class="ratings-section mb-4">
        <div class="rating-summary" (mouseenter)="showRatingModal = true" (mouseleave)="showRatingModal = false">

          <div class="stars-container">
            <div class="rating">
              <span class="stars">
                <ng-container *ngFor="let star of product.avgRating | starRating">
                  <i class="star-icon" [ngClass]="{
                    'bi bi-star-fill': star === 'full',
                    'fas fa-star-half-stroke': star === 'half',
                    'far fa-star': star === 'empty'
                  }"></i>
                </ng-container>
              </span>
              <span class="rating-text">{{ product.avgRating }} out of 5 ({{ product.totalReviews }} reviews)</span>
            </div>
          </div>

          <i *ngIf="product.avgRating > 0" class="bi bi-chevron-down dropdown-arrow"></i>

          <div class="rating-modal" *ngIf="product.avgRating > 0" [class.show]="showRatingModal"
            (mouseenter)="showRatingModal = true" (mouseleave)="showRatingModal = false">
            <div class="modal-content">
              <div class="modal-header">
                <h4>Customer Reviews</h4>
                <button type="button" class="btn-close" (click)="showRatingModal = false">
                  <i class="bi bi-x"></i>
                </button>
              </div>
              <div class="modal-body">
                <app-customer-reviews [reviewData]="reviewData" [productId]="product.id.toString()"
                  [asModal]="true"></app-customer-reviews>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="description-section">
        <h6>Description</h6>
        <p class="description-text">
          {{ product.description }}
        </p>
      </div>

      <div class="buttons-row">
        <button class="btn btn-primary" (click)="onAddToCart()">
          <i class="bi bi-cart"></i> Add to Cart
        </button>
        <button class="btn btn-secondary">
          <i class="bi bi-heart"></i>
        </button>
        <button class="btn btn-secondary">
          <i class="bi bi-share"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="zoom-preview-overlay position-fixed" [class.show]="showZoom">
    <div class="zoom-preview-container">
      <div class="zoom-preview" [style.background-image]="'url(' + getCurrentImage() + ')'"
        [style.background-position]="zoomBackgroundPosition" [style.background-size]="zoomBackgroundSize">
      </div>
      <div class="zoom-preview-border"></div>
    </div>
  </div>
</div>